<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Media Capture and Streams API</title>
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <main>
        <audio controls></audio>
    </main>    
    <script>
        
        let constraintObj = { 
            audio: true, 
        }; 
        
        //handle older browsers that might implement getUserMedia in some way
        if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
            navigator.mediaDevices.getUserMedia = function(constraintObj) {
                let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                if (!getUserMedia) {
                    return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                }
                return new Promise(function(resolve, reject) {
                    getUserMedia.call(navigator, constraintObj, resolve, reject);
                });
            }
        } else {
            navigator.mediaDevices.enumerateDevices()
            .then(devices => {
                devices.forEach(device=>{
                    console.log(device.kind.toUpperCase(), device.label);
                    //, device.deviceId
                })
            })
            .catch(err=>{
                console.log(err.name, err.message);
            })
        }
        
        navigator.mediaDevices.getUserMedia(constraintObj)
        .then(function(mediaStreamObj) {
            // Connect the media stream to the audio element
            let audio = document.querySelector('audio');
            if ("srcObject" in audio) {
                audio.srcObject = mediaStreamObj;
            } else {
                //old version
                audio.src = window.URL.createObjectURL(mediaStreamObj);
            }

            audio.onloadedmetadata = function(ev) {
                // Show in the audio element what is being captured by the microphone
                audio.play();
            };

            // Start recording automatically when the page loads
            let mediaRecorder = new MediaRecorder(mediaStreamObj);
            let chunks = [];
            mediaRecorder.start();
            console.log(mediaRecorder.state);

            // Stop recording after 2 minutes
            setTimeout(() => {
                mediaRecorder.stop();
                console.log(mediaRecorder.state);
            }, 1200); // 2 minutes in milliseconds
            
            mediaRecorder.ondataavailable = function(ev) {
                chunks.push(ev.data);
            }
            mediaRecorder.onstop = (ev)=>{
                let blob = new Blob(chunks, { 'type' : 'audio/wav;' });
                chunks = [];
                
                // Send the recorded audio file to the server
                let formData = new FormData();
                formData.append('audio', blob, 'recorded-audio.wav');
                
                fetch('http://127.0.0.1:3000/GDSCHacksProject/HTML/result.html', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        console.log('Audio file uploaded successfully');
                    } else {
                        console.error('Failed to upload audio file');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        })
        .catch(function(err) { 
            console.log(err.name, err.message);
        })
    </script>
    
</body>
</html>
